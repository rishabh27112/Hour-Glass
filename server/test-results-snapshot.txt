
> server@1.0.0 test
> NODE_OPTIONS=--experimental-vm-modules jest --forceExit --detectOpenHandles

(node:44171) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS __tests__/routes/classificationRoutes.test.js
FAIL __tests__/services/classificationService.test.js (180.877 s)
  ● Classification Service - classifyActivity › should return billable for known billable app

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      18 |   });
      19 |
    > 20 |   test('should return billable for known billable app', async () => {
         |   ^
      21 |     const mockRule = { classification: 'billable' };
      22 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      23 |

      at __tests__/services/classificationService.test.js:20:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should return non-billable for known non-billable app

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      31 |   });
      32 |
    > 33 |   test('should return non-billable for known non-billable app', async () => {
         |   ^
      34 |     const mockRule = { classification: 'non-billable' };
      35 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      36 |

      at __tests__/services/classificationService.test.js:33:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should normalize app name from path

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      43 |   });
      44 |
    > 45 |   test('should normalize app name from path', async () => {
         |   ^
      46 |     const mockRule = { classification: 'billable' };
      47 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      48 |

      at __tests__/services/classificationService.test.js:45:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should remove .exe extension

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      57 |   });
      58 |
    > 59 |   test('should remove .exe extension', async () => {
         |   ^
      60 |     const mockRule = { classification: 'billable' };
      61 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      62 |

      at __tests__/services/classificationService.test.js:59:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should return ambiguous when rule not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      77 |   });
      78 |
    > 79 |   test('should return ambiguous when rule not found', async () => {
         |   ^
      80 |     ClassificationRule.findOne.mockResolvedValue(null);
      81 |
      82 |     const result = await classifyActivity({

      at __tests__/services/classificationService.test.js:79:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should handle database errors gracefully

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      88 |   });
      89 |
    > 90 |   test('should handle database errors gracefully', async () => {
         |   ^
      91 |     ClassificationRule.findOne.mockRejectedValue(new Error('DB error'));
      92 |
      93 |     const result = await classifyActivity({

      at __tests__/services/classificationService.test.js:90:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should handle forward slashes in path

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

       99 |   });
      100 |
    > 101 |   test('should handle forward slashes in path', async () => {
          |   ^
      102 |     const mockRule = { classification: 'billable' };
      103 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      104 |

      at __tests__/services/classificationService.test.js:101:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should handle mixed path separators

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      113 |   });
      114 |
    > 115 |   test('should handle mixed path separators', async () => {
          |   ^
      116 |     const mockRule = { classification: 'billable' };
      117 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      118 |

      at __tests__/services/classificationService.test.js:115:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should handle appname with special characters

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      127 |   });
      128 |
    > 129 |   test('should handle appname with special characters', async () => {
          |   ^
      130 |     const mockRule = { classification: 'billable' };
      131 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      132 |

      at __tests__/services/classificationService.test.js:129:3
      at __tests__/services/classificationService.test.js:15:1

  ● Classification Service - classifyActivity › should return billable for known billable app

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      145 |   });
      146 |
    > 147 |   test('should return billable for known billable app', async () => {
          |   ^
      148 |     const mockRule = { classification: 'billable' };
      149 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      150 |

      at __tests__/services/classificationService.test.js:147:3
      at __tests__/services/classificationService.test.js:142:1

  ● Classification Service - classifyActivity › should return non-billable for known non-billable app

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      158 |   });
      159 |
    > 160 |   test('should return non-billable for known non-billable app', async () => {
          |   ^
      161 |     const mockRule = { classification: 'non-billable' };
      162 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      163 |

      at __tests__/services/classificationService.test.js:160:3
      at __tests__/services/classificationService.test.js:142:1

  ● Classification Service - classifyActivity › should normalize app name from path

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      170 |   });
      171 |
    > 172 |   test('should normalize app name from path', async () => {
          |   ^
      173 |     const mockRule = { classification: 'billable' };
      174 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      175 |

      at __tests__/services/classificationService.test.js:172:3
      at __tests__/services/classificationService.test.js:142:1

  ● Classification Service - classifyActivity › should remove .exe extension

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      184 |   });
      185 |
    > 186 |   test('should remove .exe extension', async () => {
          |   ^
      187 |     const mockRule = { classification: 'billable' };
      188 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      189 |

      at __tests__/services/classificationService.test.js:186:3
      at __tests__/services/classificationService.test.js:142:1

  ● Classification Service - classifyActivity › should return ambiguous when rule not found

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      204 |   });
      205 |
    > 206 |   test('should return ambiguous when rule not found', async () => {
          |   ^
      207 |     ClassificationRule.findOne.mockResolvedValue(null);
      208 |
      209 |     const result = await classifyActivity({

      at __tests__/services/classificationService.test.js:206:3
      at __tests__/services/classificationService.test.js:142:1

  ● Classification Service - classifyActivity › should handle database errors gracefully

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      215 |   });
      216 |
    > 217 |   test('should handle database errors gracefully', async () => {
          |   ^
      218 |     ClassificationRule.findOne.mockRejectedValue(new Error('DB error'));
      219 |
      220 |     const result = await classifyActivity({

      at __tests__/services/classificationService.test.js:217:3
      at __tests__/services/classificationService.test.js:142:1

  ● Classification Service - classifyActivity › should handle forward slashes in path

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      226 |   });
      227 |
    > 228 |   test('should handle forward slashes in path', async () => {
          |   ^
      229 |     const mockRule = { classification: 'billable' };
      230 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      231 |

      at __tests__/services/classificationService.test.js:228:3
      at __tests__/services/classificationService.test.js:142:1

  ● Classification Service - classifyActivity › should handle mixed path separators

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      240 |   });
      241 |
    > 242 |   test('should handle mixed path separators', async () => {
          |   ^
      243 |     const mockRule = { classification: 'billable' };
      244 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      245 |

      at __tests__/services/classificationService.test.js:242:3
      at __tests__/services/classificationService.test.js:142:1

  ● Classification Service - classifyActivity › should handle appname with special characters

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      254 |   });
      255 |
    > 256 |   test('should handle appname with special characters', async () => {
          |   ^
      257 |     const mockRule = { classification: 'billable' };
      258 |     ClassificationRule.findOne.mockResolvedValue(mockRule);
      259 |

      at __tests__/services/classificationService.test.js:256:3
      at __tests__/services/classificationService.test.js:142:1

FAIL __tests__/services/brainstormService.test.js
  ● Console

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:185:22)

    console.error
      [Brainstorm] Failed to fetch task: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      134 |       }
      135 |     } catch (err) {
    > 136 |       console.error('[Brainstorm] Failed to fetch task:', err.message);
          |               ^
      137 |     }
      138 |   }
      139 |

      at classifyBrainstormEntry (services/brainstormService.js:136:15)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:185:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:227:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:264:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:302:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:318:22)

    console.warn
      [Brainstorm] No GROQ_API_KEY; returning ambiguous

      13 |   const GROQ_KEY = process.env.GROQ_API_KEY;
      14 |   if (!GROQ_KEY) {
    > 15 |     console.warn('[Brainstorm] No GROQ_API_KEY; returning ambiguous');
         |             ^
      16 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'API key not configured' };
      17 |   }
      18 |

      at callGroqForBrainstorm (services/brainstormService.js:15:13)
      at classifyBrainstormEntry (services/brainstormService.js:141:16)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:318:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:372:22)

    console.error
      [Brainstorm] Groq API error: 400 {"error":{"message":"Invalid model"}}

      70 |     if (!resp.ok) {
      71 |       const errText = await resp.text();
    > 72 |       console.error('[Brainstorm] Groq API error:', resp.status, errText);
         |               ^
      73 |       throw new Error(`Groq API ${resp.status}: ${errText.slice(0, 200)}`);
      74 |     }
      75 |

      at callGroqForBrainstorm (services/brainstormService.js:72:15)
      at classifyBrainstormEntry (services/brainstormService.js:141:10)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:372:22)

    console.error
      [Brainstorm] Groq API error: Groq API 400: {"error":{"message":"Invalid model"}}

       97 |     };
       98 |   } catch (err) {
    >  99 |     console.error('[Brainstorm] Groq API error:', err.message);
          |             ^
      100 |     return {
      101 |       classification: 'ambiguous',
      102 |       confidence: 0,

      at callGroqForBrainstorm (services/brainstormService.js:99:13)
      at classifyBrainstormEntry (services/brainstormService.js:141:10)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:372:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:395:22)

    console.error
      [Brainstorm] Groq API error: Network timeout

       97 |     };
       98 |   } catch (err) {
    >  99 |     console.error('[Brainstorm] Groq API error:', err.message);
          |             ^
      100 |     return {
      101 |       classification: 'ambiguous',
      102 |       confidence: 0,

      at callGroqForBrainstorm (services/brainstormService.js:99:13)
      at classifyBrainstormEntry (services/brainstormService.js:141:10)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:395:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:425:22)

    console.error
      [Brainstorm] Groq API error: No response from Groq API

       97 |     };
       98 |   } catch (err) {
    >  99 |     console.error('[Brainstorm] Groq API error:', err.message);
          |             ^
      100 |     return {
      101 |       classification: 'ambiguous',
      102 |       confidence: 0,

      at callGroqForBrainstorm (services/brainstormService.js:99:13)
      at classifyBrainstormEntry (services/brainstormService.js:141:10)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:425:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:452:22)

    console.error
      [Brainstorm] Groq API error: Invalid JSON

       97 |     };
       98 |   } catch (err) {
    >  99 |     console.error('[Brainstorm] Groq API error:', err.message);
          |             ^
      100 |     return {
      101 |       classification: 'ambiguous',
      102 |       confidence: 0,

      at callGroqForBrainstorm (services/brainstormService.js:99:13)
      at classifyBrainstormEntry (services/brainstormService.js:141:10)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:452:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "invalid-project-id" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:485:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:518:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:557:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:598:7)

    console.error
      [Brainstorm] Failed to fetch task: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      134 |       }
      135 |     } catch (err) {
    > 136 |       console.error('[Brainstorm] Failed to fetch task:', err.message);
          |               ^
      137 |     }
      138 |   }
      139 |

      at classifyBrainstormEntry (services/brainstormService.js:136:15)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:598:7)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:649:22)

    console.error
      [Brainstorm] Failed to fetch task: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      134 |       }
      135 |     } catch (err) {
    > 136 |       console.error('[Brainstorm] Failed to fetch task:', err.message);
          |               ^
      137 |     }
      138 |   }
      139 |

      at classifyBrainstormEntry (services/brainstormService.js:136:15)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:649:22)

    console.error
      [Brainstorm] Failed to fetch project: Cast to ObjectId failed for value "proj-123" (type string) at path "_id" for model "Project"

      121 |     }
      122 |   } catch (err) {
    > 123 |     console.error('[Brainstorm] Failed to fetch project:', err.message);
          |             ^
      124 |   }
      125 |
      126 |   // Fetch task details if provided

      at classifyBrainstormEntry (services/brainstormService.js:123:13)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:689:7)

  ● Brainstorm Service - classifyBrainstormEntry › should return ambiguous when no GROQ key

    TypeError: description.trim is not a function

      107 |
      108 | export async function classifyBrainstormEntry(description, projectId, taskId = null) {
    > 109 |   if (!description || !description.trim()) {
          |                                    ^
      110 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'Empty description' };
      111 |   }
      112 |

      at classifyBrainstormEntry (services/brainstormService.js:109:36)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:24:23)

  ● Brainstorm Service - classifyBrainstormEntry › should handle project fetch and call Groq

    TypeError: description.trim is not a function

      107 |
      108 | export async function classifyBrainstormEntry(description, projectId, taskId = null) {
    > 109 |   if (!description || !description.trim()) {
          |                                    ^
      110 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'Empty description' };
      111 |   }
      112 |

      at classifyBrainstormEntry (services/brainstormService.js:109:36)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:44:23)

  ● Brainstorm Service - classifyBrainstormEntry › should clamp confidence between 0 and 1

    TypeError: description.trim is not a function

      107 |
      108 | export async function classifyBrainstormEntry(description, projectId, taskId = null) {
    > 109 |   if (!description || !description.trim()) {
          |                                    ^
      110 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'Empty description' };
      111 |   }
      112 |

      at classifyBrainstormEntry (services/brainstormService.js:109:36)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:63:23)

  ● Brainstorm Service - classifyBrainstormEntry › should handle API errors gracefully

    TypeError: description.trim is not a function

      107 |
      108 | export async function classifyBrainstormEntry(description, projectId, taskId = null) {
    > 109 |   if (!description || !description.trim()) {
          |                                    ^
      110 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'Empty description' };
      111 |   }
      112 |

      at classifyBrainstormEntry (services/brainstormService.js:109:36)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:72:23)

  ● Brainstorm Service - classifyBrainstormEntry › should return ambiguous when no GROQ key

    TypeError: description.trim is not a function

      107 |
      108 | export async function classifyBrainstormEntry(description, projectId, taskId = null) {
    > 109 |   if (!description || !description.trim()) {
          |                                    ^
      110 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'Empty description' };
      111 |   }
      112 |

      at classifyBrainstormEntry (services/brainstormService.js:109:36)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:87:23)

  ● Brainstorm Service - classifyBrainstormEntry › should handle project fetch and call Groq

    TypeError: description.trim is not a function

      107 |
      108 | export async function classifyBrainstormEntry(description, projectId, taskId = null) {
    > 109 |   if (!description || !description.trim()) {
          |                                    ^
      110 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'Empty description' };
      111 |   }
      112 |

      at classifyBrainstormEntry (services/brainstormService.js:109:36)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:107:23)

  ● Brainstorm Service - classifyBrainstormEntry › should clamp confidence between 0 and 1

    TypeError: description.trim is not a function

      107 |
      108 | export async function classifyBrainstormEntry(description, projectId, taskId = null) {
    > 109 |   if (!description || !description.trim()) {
          |                                    ^
      110 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'Empty description' };
      111 |   }
      112 |

      at classifyBrainstormEntry (services/brainstormService.js:109:36)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:126:23)

  ● Brainstorm Service - classifyBrainstormEntry › should handle API errors gracefully

    TypeError: description.trim is not a function

      107 |
      108 | export async function classifyBrainstormEntry(description, projectId, taskId = null) {
    > 109 |   if (!description || !description.trim()) {
          |                                    ^
      110 |     return { classification: 'ambiguous', confidence: 0, reasoning: 'Empty description' };
      111 |   }
      112 |

      at classifyBrainstormEntry (services/brainstormService.js:109:36)
      at Object.<anonymous> (__tests__/services/brainstormService.test.js:135:23)

  ● Brainstorm Service - classifyBrainstormEntry › Edge Cases › should pass correct parameters to Groq API

    expect(received).toContain(expected) // indexOf

    Expected substring: "Client Project"
    Received string:    "
    You are a productivity classifier. Determine if a brainstorm session is billable or non-billable.·
    CRITERIA:
    Billable:
      - Directly contributes to an assigned task or project deliverable
      - Aligns with explicit project goals and client requirements
      - Produces actionable insights for the assigned work
      - Collaboratively develops solutions for project needs
      - Supports existing scope and timeline·
    Non-Billable:
      - General ideation or exploration without specific task assignment
      - Personal skill development or learning unrelated to immediate project goals
      - Informal brainstorming not linked to a deliverable
      - Speculative research beyond project scope
      - Social or team-building activities·
    CONTEXT:
    Project: \"Unknown\"
    Project Description: \"N/A\"
    Assigned Task: \"No specific task\"·
    BRAINSTORM DESCRIPTION:
    Building React components·
    Respond in this exact format:
    CLASSIFICATION: [billable|non-billable]
    CONFIDENCE: [0.0-1.0]
    REASONING: [1-2 sentence explanation]
    "

      607 |       expect(requestBody.model).toBe('llama-3.3-70b-versatile');
      608 |       expect(requestBody.messages[0].role).toBe('user');
    > 609 |       expect(requestBody.messages[0].content).toContain('Client Project');
          |                                               ^
      610 |       expect(requestBody.messages[0].content).toContain('Building React components');
      611 |       expect(requestBody.temperature).toBe(0.3);
      612 |       expect(requestBody.max_tokens).toBe(300);

      at Object.<anonymous> (__tests__/services/brainstormService.test.js:609:47)

FAIL __tests__/routes/classificationRoutes.esm.test.js
  ● Classification Routes (ESM-style mocked imports) › PATCH returns 403 when user not verified

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      123 |
      124 |     const res = await request(app).patch('/api/classification-rules/slack').send({ classification: 'billable' });
    > 125 |     expect(res.status).toBe(403);
          |                        ^
      126 |   });
      127 |
      128 |   test('DELETE removes rule when verified', async () => {

      at Object.<anonymous> (__tests__/routes/classificationRoutes.esm.test.js:125:24)

Test Suites: 3 failed, 1 passed, 4 total
Tests:       28 failed, 34 passed, 62 total
Snapshots:   0 total
Time:        183.222 s
Ran all test suites.
